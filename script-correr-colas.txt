#!/bin/bash

echo "ðŸ”„ Iniciando instalaciÃ³n y configuraciÃ³n de colas en Laravel..."

# 1ï¸âƒ£ Reparar paquetes en APT
echo "ðŸ“¦ Reinstalando python3-apt..."
sudo apt install --reinstall -y python3-apt

echo "ðŸ”§ Corrigiendo paquetes daÃ±ados..."
sudo dpkg --configure -a

echo "ðŸ§¹ Limpiando cachÃ© de APT..."
sudo apt clean

echo "ðŸ”„ Actualizando paquetes y corrigiendo errores..."
sudo apt update --fix-missing

# 2ï¸âƒ£ Instalar Supervisor
echo "âš™ Instalando Supervisor..."
sudo apt install -y supervisor

# 3ï¸âƒ£ Configurar el worker de Laravel
echo "ðŸ“ Creando configuraciÃ³n del worker Laravel..."
sudo bash -c 'cat > /etc/supervisor/conf.d/laravel-worker.conf <<EOF
[program:laravel-worker]
command=php /var/www/html/vemitienda/artisan queue:work --tries=3
autostart=true
autorestart=true
user=www-data
redirect_stderr=true
stdout_logfile=/var/log/laravel-worker.log
EOF'

# 4ï¸âƒ£ Recargar Supervisor y activar el worker
echo "ðŸ”„ Recargando Supervisor..."
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start laravel-worker

# 5ï¸âƒ£ Verificar estado del worker
echo "âœ… Estado del Worker Laravel:"
sudo supervisorctl status laravel-worker


echo "ðŸš€ InstalaciÃ³n completa. Â¡Las colas estÃ¡n corriendo!"
